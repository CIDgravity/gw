<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <title>RIBSWeb</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Yantramanav">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Press+Start+2P">
    <script>

        const states = [
            "Writable",
            "Full",
            "BSSTExists",
            "LevelIndexDropped",
            "VRCARDone",
            "HasCommp",
            "DealsInProgress",
            "DealsDone",
            "Offloaded",
        ]

        function formatBytesBinary(bytes) {
            const units = ['B', 'KiB', 'MiB', 'GiB', 'TiB', 'PiB', 'EiB', 'ZiB', 'YiB'];
            let l = 0, n = parseInt(bytes, 10) || 0;
            while (n >= 1024 && ++l) {
                n = n / 1024;
            }
            return (n.toFixed(n < 10 && l > 0 ? 1 : 0) + ' ' + units[l]);
        }

        function formatNum(bytes) {
            const units = ['', 'k', 'M', 'G', 'T', 'P', 'E', 'Z', 'Y'];
            let l = 0, n = parseInt(bytes, 10) || 0;
            while (n >= 1000 && ++l) {
                n = n / 1000;
            }
            return (n.toFixed(n < 10 && l > 0 ? 1 : 0) + ' ' + units[l]);
        }

        function formatPercent(num) {
            return (num * 100).toFixed(1) + '%';
        }

        function formatFil(n) {
            if (n === 0) {
                return '0';
            }

            const units = ['aFIL', 'fFIL', 'pFIL', 'nFIL', 'uFIL', 'mFIL', 'FIL'];
            let l = 0;
            while (l+1 < units.length && n >= 1000) {
                l++;
                n = n / 1000;
            }

            return (n.toFixed(n < 10 && l > 0 ? 1 : 0) + ' ' + units[l]);
        }

        console.log(formatFil(120_000))

        const avgMonthDays = 30.436875;
        const epochToMonth = (60/30) * 60 * 24 * avgMonthDays;

        let groupElems = {};
        let providerElems = {};

        let loopId = 0;
        const nonWritableRefreshEvery = 15;

        let totalBlocks = 0;
        let totalBytes = 0;

        async function refresh() {
            loopId++;

            let response = await fetch('http://127.0.0.1:9010/api/v0/state');
            let state = await response.json();

            document.querySelector('#sp-tracker-state').innerHTML = state.CrawlState;

            let groups = state.Groups;
            let groupsDiv = document.querySelector('.groups');

            for (let i = groups.length - 1; i >= 0; i--) {
                let group = groups[i];

                if(groupElems[group] !== undefined && groupElems[group].meta.State != 0) {
                    if(loopId % nonWritableRefreshEvery != i % nonWritableRefreshEvery) {
                        continue;
                    }
                }

                let metaResp = await fetch(`http://127.0.0.1:9010/api/v0/group?group=${group}`);
                let meta = await metaResp.json();

                /*
                * type GroupMeta struct {
                    State GroupState

                    MaxBlocks int64
                    MaxBytes  int64

                    Blocks int64
                    Bytes  int64
                }
                * */

                if(groupElems[group] === undefined) {
                    let groupElem = document.createElement('div');
                    groupElem.classList.add('group');

                    let groupLeftElem = document.createElement('div');
                    groupLeftElem.classList.add('group-left');

                    let groupHeadElem = document.createElement('div');
                    groupHeadElem.classList.add('group-head');

                    let groupNameElem = document.createElement('div');
                    groupNameElem.classList.add('group-name');
                    groupNameElem.innerText = group;

                    let groupStatusElem = document.createElement('div');
                    groupStatusElem.classList.add('group-status');

                    let groupRowSizeElem = document.createElement('div');
                    groupRowSizeElem.classList.add('group-row');
                    let groupRowBlocksElem = document.createElement('div');

                    groupRowBlocksElem.classList.add('group-row');
                    let groupRightElem = document.createElement('div');

                    groupRightElem.classList.add('group-right');

                    let groupBarSizeElem = document.createElement('div');
                    groupBarSizeElem.classList.add('group-bar');
                    groupBarSizeElem.classList.add('group-bar-size');
                    groupBarSizeElem.innerText = '.';

                    let groupBarBlocksElem = document.createElement('div');
                    groupBarBlocksElem.classList.add('group-bar');
                    groupBarBlocksElem.classList.add('group-bar-blocks');
                    groupBarBlocksElem.innerText = '.';

                    let groupTxDealInfo = document.createElement('div');
                    groupTxDealInfo.classList.add('group-tx-deal-info');
                    groupTxDealInfo.innerText = 'Uploads 0 (0 B/s)';

                    groupHeadElem.appendChild(groupNameElem);

                    groupHeadElem.appendChild(groupStatusElem);
                    groupLeftElem.appendChild(groupHeadElem);

                    groupLeftElem.appendChild(groupRowSizeElem);
                    groupLeftElem.appendChild(groupRowBlocksElem);

                    groupRightElem.appendChild(groupBarSizeElem);
                    groupRightElem.appendChild(groupBarBlocksElem);
                    groupRightElem.appendChild(groupTxDealInfo);

                    groupElem.appendChild(groupLeftElem);

                    groupElem.appendChild(groupRightElem);

                    groupsDiv.insertBefore(groupElem, groupsDiv.firstChild);

                    totalBlocks += meta.Blocks;
                    totalBytes += meta.Bytes;

                    groupElems[group] = {groupElem, groupStatusElem, groupRowSizeElem, groupRowBlocksElem, groupTxDealInfo, groupBarSizeElem, groupBarBlocksElem, meta}
                }

                totalBlocks -= groupElems[group].meta.Blocks;
                totalBytes -= groupElems[group].meta.Bytes;
                totalBlocks += meta.Blocks;
                totalBytes += meta.Bytes;

                groupElems[group].meta = meta;
                groupElems[group].groupStatusElem.innerText = states[meta.State];
                groupElems[group].groupRowSizeElem.innerText = `${formatBytesBinary(meta.Bytes)} / ${formatBytesBinary(meta.MaxBytes)} (${formatPercent(meta.Bytes / meta.MaxBytes)})`;
                groupElems[group].groupRowBlocksElem.innerText = `${formatNum(meta.Blocks)} / ${formatNum(meta.MaxBlocks)} (${formatPercent(meta.Blocks / meta.MaxBlocks)}) blocks`;
                groupElems[group].groupBarSizeElem.style.width = `${formatPercent(meta.Bytes / meta.MaxBytes)}`;
                groupElems[group].groupBarBlocksElem.style.width = `${formatPercent(meta.Blocks / meta.MaxBlocks)}`;

                if(state.CarUploads[group] !== undefined) {
                    groupElems[group].groupTxDealInfo.innerText = `Uploads ${state.CarUploads[group].ActiveRequests} (${formatBytesBinary(state.CarUploads[group].Last250MsUploadBytes*4)}/s)`;
                }
            }

            document.getElementById("total-bytes").innerText = formatBytesBinary(totalBytes);
            document.getElementById("total-blocks").innerText = formatNum(totalBlocks) + " blocks";

            for (let i = state.Providers.length - 1; i >= 0; i--) {
                let provider = state.Providers[i];

                if(providerElems[provider.ID] === undefined) {
                    let providerElem = document.createElement('tr');
                    providerElem.classList.add('provider');

                    let providerAddrElem = document.createElement('td');
                    providerAddrElem.classList.add('provider-addr');
                    providerAddrElem.innerText = "f0" + provider.ID;

                    let providerPieceSizesElem = document.createElement('td');
                    providerPieceSizesElem.classList.add('provider-piece-sizes');

                    let providerPriceElem = document.createElement('td');
                    providerPriceElem.classList.add('provider-price');

                    let providerFeaturesElem = document.createElement('td');
                    providerFeaturesElem.classList.add('provider-features');

                    providerElem.appendChild(providerAddrElem);
                    providerElem.appendChild(providerPieceSizesElem);
                    providerElem.appendChild(providerPriceElem);
                    providerElem.appendChild(providerFeaturesElem);

                    document.querySelector('.providers').appendChild(providerElem);

                    providerElems[provider.ID] = {providerElem, providerPieceSizesElem, providerPriceElem, providerFeaturesElem}
                }

                providerElems[provider.ID].providerPieceSizesElem.innerText = `${formatBytesBinary(provider.AskMinPieceSize)} to ${formatBytesBinary(provider.AskMaxPieceSize)}`;
                providerElems[provider.ID].providerPriceElem.innerText = `${formatFil(provider.AskPrice*epochToMonth)} (${formatFil(provider.AskVerifiedPrice*epochToMonth)})`;

                providerElems[provider.ID].providerFeaturesElem.innerText = `${provider.PingOk ? 'online' : 'offline'} ${provider.BoostDeals ? 'boost ' : ''}${provider.BoosterHttp ? 'http ' : ''}${provider.BoosterBitswap ? 'bitswap ' : ''}`;
            }

            // todo this is flimsy
            setTimeout(refresh, 100);
        };

        refresh();
    </script>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            background-color: #f0f0f0;
            color: #000000;
            font-family: 'Yantramanav', sans-serif;
        }

        .groups {
            width: 100%;
        }

        .group {
            width: 100%;
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            box-sizing: border-box;
            border-bottom: 1px solid #000000;
        }

        .group-left {
            display: flex;
            flex-direction: column;
            align-items: flex-start;

            padding: 1em;
            border-right: 1px solid #000000;
        }

        .group-head {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .group-right {
            display: flex;
            flex-direction: column;
            height: 100%;

            flex-grow: 1;
            border: 1px solid #000000;
        }

        .group-bar {
            flex-grow: 1;
        }

        .group-bar-size {
            background-color: #00ff00;
        }

        .group-bar-blocks {
            background-color: #0000ff;
        }
    </style>
</head>
<body>
<h2>SP Tracker</h2>
<div id="sp-tracker-state"></div>
<hr>
<h2>Groups</h2>
<div class="group">
    <div class="group-left">
        <div class="group-head">
            <div class="group-name">TOTAL</div>
        </div><div class="group-row" id="total-bytes">0</div>
        <div class="group-row" id="total-blocks"></div>
    </div>
</div>
<div class="groups"></div>
<table class="providers">
    <td>Address</td><td>Piece Sizes</td><td><abbr title="FIL/GiB/mo">Price (Fil+)</abbr></td><td>Features</td>
</table>
</body>
</html>
