package ributil

import (
	"github.com/raulk/go-watchdog"
	"time"
)

func MemoryWatchdog() (cleanup func()) {
	// configure heap profile capture so that one is captured per episode where
	// utilization climbs over 90% of the limit. A maximum of 10 heapdumps
	// will be captured during life of this process.
	watchdog.HeapProfileMaxCaptures = 10
	watchdog.HeapProfileThreshold = 0.9

	policy := watchdog.NewWatermarkPolicy(0.50, 0.60, 0.70, 0.85, 0.90, 0.925, 0.95)

	// Try to initialize a watchdog in the following order of precedence:
	// 1. If a max heap limit has been provided, initialize a heap-driven watchdog.
	// 2. Else, try to initialize a cgroup-driven watchdog.
	// 3. Else, try to initialize a system-driven watchdog.
	// 4. Else, log a warning that the system is flying solo, and return.

	var onExit []func()

	addStopHook := func(stopFn func()) {
		onExit = append(onExit, stopFn)
	}

	cleanup = func() {
		for _, fn := range onExit {
			fn()
		}
	}

	// 1. If user has set max heap limit, apply it.
	if maxHeap := uint64(0); maxHeap != 0 {
		const minGOGC = 10
		err, stopFn := watchdog.HeapDriven(maxHeap, minGOGC, policy)
		if err == nil {
			log.Infof("initialized heap-driven watchdog; max heap: %d bytes", maxHeap)
			addStopHook(stopFn)
			return
		}
		log.Warnf("failed to initialize heap-driven watchdog; err: %s", err)
		log.Warnf("trying a cgroup-driven watchdog")
	}

	// 2. cgroup-driven watchdog.
	err, stopFn := watchdog.CgroupDriven(5*time.Second, policy)
	if err == nil {
		log.Infof("initialized cgroup-driven watchdog")
		addStopHook(stopFn)
		return
	}
	log.Warnf("failed to initialize cgroup-driven watchdog; err: %s", err)
	log.Warnf("trying a system-driven watchdog")

	// 3. system-driven watchdog.
	err, stopFn = watchdog.SystemDriven(0, 5*time.Second, policy) // 0 calculates the limit automatically.
	if err == nil {
		log.Infof("initialized system-driven watchdog")
		addStopHook(stopFn)
		return
	}

	// 4. log the failure
	log.Warnf("failed to initialize system-driven watchdog; err: %s", err)
	log.Warnf("system running without a memory watchdog")
	return
}

